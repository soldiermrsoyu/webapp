<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Task Menu - SPV</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div class="container dashboard">
    <div class="header-section">
      <h1>Daftar Jadwal Maintenance</h1>
      <button class="btn-back" onclick="location.href='/spv'">‚Üê Kembali</button>
    </div>
    
    <div class="menu-grid">
      <div class="menu-card" onclick="showModal('fcu')">
        <div class="menu-icon">‚ùÑÔ∏è</div>
        <div class="menu-title">FCU</div>
        <div class="menu-desc">Fan Coil Unit</div>
      </div>
      <div class="menu-card" onclick="showModal('pump')">
        <div class="menu-icon">üíß</div>
        <div class="menu-title">PUMP</div>
        <div class="menu-desc">Water Pump System</div>
      </div>
      <div class="menu-card" onclick="showModal('genset')">
        <div class="menu-icon">‚ö°</div>
        <div class="menu-title">GENSET</div>
        <div class="menu-desc">Generator Set</div>
      </div>
      <div class="menu-card" onclick="showModal('electric')">
        <div class="menu-icon">üîå</div>
        <div class="menu-title">ELECTRIC</div>
        <div class="menu-desc">Electrical Panel</div>
      </div>
      <div class="menu-card" onclick="showModal('mcfa')">
        <div class="menu-icon">‚öôÔ∏è</div>
        <div class="menu-title">MCFA</div>
        <div class="menu-desc">Fire Alarm System</div>
      </div>
    </div>
  </div>

  <!-- FCU Modal - List View -->
  <div id="fcuModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>FCU - Daftar Unit</h2>
        <span class="close" onclick="closeModal('fcu')">&times;</span>
      </div>
      <div class="modal-body">
        <div id="fcuList" class="fcu-list"></div>
      </div>
    </div>
  </div>

  <!-- FCU Detail Modal -->
  <div id="fcuDetailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Detail FCU</h2>
        <span class="close" onclick="closeModal('fcuDetail')">&times;</span>
      </div>
      <div class="modal-body">
        <div id="fcuDetailContent">
          <table class="detail-table">
            <tr>
              <td><strong>ID</strong></td>
              <td id="detail-id"></td>
            </tr>
            <tr>
              <td><strong>Lantai</strong></td>
              <td id="detail-lantai"></td>
            </tr>
            <tr>
              <td><strong>Unit</strong></td>
              <td id="detail-unit"></td>
            </tr>
            <tr>
              <td><strong>Alias</strong></td>
              <td id="detail-alias"></td>
            </tr>
            <tr>
              <td><strong>Tanggal</strong></td>
              <td id="detail-tanggal"></td>
            </tr>
          </table>
        </div>
        <div class="modal-actions" style="margin-top: 20px;">
          <button onclick="showHistoryModal()" class="btn-secondary" style="background: #64748b;">Lihat Riwayat</button>
          <button onclick="showTeknijiModal()" class="btn-primary">Pilih Teknisi</button>
          <button onclick="closeModal('fcuDetail')" class="btn-secondary">Kembali</button>
        </div>
      </div>
    </div>
  </div>

  <!-- History Modal -->
  <div id="historyModal" class="modal">
    <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
      <div class="modal-header">
        <h2>Riwayat Maintenance</h2>
        <span class="close" onclick="closeModal('history')">&times;</span>
      </div>
      <div class="modal-body">
        <div id="historyContent" class="history-list">
          <!-- History items will be injected here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Teknisi Selection Modal -->
  <div id="teknijiModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Pilih Teknisi</h2>
        <span class="close" onclick="closeModal('tekniji')">&times;</span>
      </div>
      <div class="modal-body">
        <div id="teknijiList" class="tekniji-list"></div>
        <div class="modal-actions" style="margin-top: 20px; text-align: right;">
          <button onclick="submitMultipleAssignments()" class="btn-primary">Kirim Tugas</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Other Equipment Modals -->
  <div id="pumpModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>PUMP - Jadwal Maintenance</h2>
        <span class="close" onclick="closeModal('pump')">&times;</span>
      </div>
      <div class="modal-body">
        <p>Jadwal maintenance untuk PUMP akan segera hadir</p>
      </div>
    </div>
  </div>

  <div id="gensetModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>GENSET - Jadwal Maintenance</h2>
        <span class="close" onclick="closeModal('genset')">&times;</span>
      </div>
      <div class="modal-body">
        <p>Jadwal maintenance untuk GENSET akan segera hadir</p>
      </div>
    </div>
  </div>

  <div id="electricModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ELECTRIC - Jadwal Maintenance</h2>
        <span class="close" onclick="closeModal('electric')">&times;</span>
      </div>
      <div class="modal-body">
        <p>Jadwal maintenance untuk ELECTRIC akan segera hadir</p>
      </div>
    </div>
  </div>

  <div id="mcfaModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>MCFA - Jadwal Maintenance</h2>
        <span class="close" onclick="closeModal('mcfa')">&times;</span>
      </div>
      <div class="modal-body">
        <p>Jadwal maintenance untuk MCFA akan segera hadir</p>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <a href="/spv" class="nav-item" id="home-nav">
      <div class="nav-icon">üè†</div>
      <div class="nav-label">Home</div>
    </a>
    <a href="/spv/notifikasi" class="nav-item" id="notif-nav">
      <div class="nav-icon">üîî</div>
      <div class="nav-label">Notifikasi</div>
    </a>
    <a href="/spv/profile" class="nav-item" id="profile-nav">
      <div class="nav-icon">üë§</div>
      <div class="nav-label">Profile</div>
    </a>
  </nav>

  <script>
    let selectedFCU = null;

    function showModal(type) {
      const modalId = type + 'Modal';
      document.getElementById(modalId).style.display = 'block';
      
      if (type === 'fcu') {
        loadFCUList();
      }
    }

    function closeModal(type) {
      const modalId = type + 'Modal';
      document.getElementById(modalId).style.display = 'none';
    }

    function loadFCUList() {
      fetch('/api/jadwal')
        .then(response => response.json())
        .then(data => {
          const fcuList = document.getElementById('fcuList');
          if (data.length === 0) {
            fcuList.innerHTML = '<p>Tidak ada jadwal FCU untuk hari ini</p>';
            return;
          }
          
          let html = '<div class="fcu-items">';
          data.forEach((item, index) => {
            const date = new Date(item.tanggal).toLocaleDateString('id-ID', {
              day: 'numeric', month: 'short', year: 'numeric'
            });
            html += `<div class="fcu-item" data-index="${index}" data-id="${item.id}" data-lantai="${item.lantai}" data-unit="${item.unit}" data-alias="${item.alias}" data-tanggal="${date}">
              <div class="fcu-id">${item.unit}</div>
              <div class="fcu-info">
                <span>${item.lantai}</span>
                <small>${item.alias}</small>
              </div>
              <div class="fcu-buttons">
                <button class="btn-small fcu-detail-btn">Detail</button>
              </div>
            </div>`;
          });
          html += '</div>';
          fcuList.innerHTML = html;
          
          // Add event listeners to all detail buttons
          document.querySelectorAll('.fcu-detail-btn').forEach(btn => {
            btn.addEventListener('click', function() {
              const item = this.closest('.fcu-item');
              showFCUDetail(
                item.dataset.id,
                item.dataset.lantai,
                item.dataset.unit,
                item.dataset.alias,
                item.dataset.tanggal
              );
            });
          });
        })
        .catch(error => {
          console.error('Error:', error);
          document.getElementById('fcuList').innerHTML = '<p>Error loading data</p>';
        });
    }

    function showFCUDetail(id, lantai, unit, alias, tanggal) {
      console.log('Setting selectedFCU:', { id, lantai, unit, alias, tanggal });
      // Ensure id is an integer
      id = parseInt(id);
      selectedFCU = { id, lantai, unit, alias, tanggal };
      document.getElementById('detail-id').textContent = id;
      document.getElementById('detail-lantai').textContent = lantai;
      document.getElementById('detail-unit').textContent = unit;
      document.getElementById('detail-alias').textContent = alias;
      document.getElementById('detail-tanggal').textContent = tanggal;
      
      closeModal('fcu');
      showModal('fcuDetail');
    }

    function showTeknijiModal() {
      loadTeknijiList();
      closeModal('fcuDetail');
      showModal('tekniji');
    }

    function showHistoryModal() {
      if (!selectedFCU) return;
      
      const historyContent = document.getElementById('historyContent');
      historyContent.innerHTML = '<p style="text-align: center; padding: 20px;">Memuat riwayat...</p>';
      
      showModal('history');
      
      fetch(`/api/fcu-history/${selectedFCU.id}`)
        .then(res => res.json())
        .then(data => {
          if (data.length === 0) {
            historyContent.innerHTML = '<p style="text-align: center; padding: 20px;">Belum ada riwayat untuk unit ini.</p>';
            return;
          }
          
          let html = '';
          data.forEach(item => {
            const date = new Date(item.created_at).toLocaleDateString('id-ID', {
              day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit'
            });
            html += `
              <div class="history-item" style="border-bottom: 1px solid #eee; padding: 15px 0;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                  <strong style="color: var(--primary-color);">${date}</strong>
                  <span style="font-size: 0.8rem; color: #666;">Oleh: ${item.teknisi_name}</span>
                </div>
                <div style="font-size: 0.9rem;">
                  <p><strong>Temuan:</strong> ${item.findings}</p>
                  <p><strong>Tindakan:</strong> ${item.actions_taken}</p>
                  ${item.next_maintenance_date ? `<p style="color: #059669;"><strong>Jadwal Berikutnya:</strong> ${new Date(item.next_maintenance_date).toLocaleDateString('id-ID')}</p>` : ''}
                </div>
              </div>
            `;
          });
          historyContent.innerHTML = html;
        })
        .catch(err => {
          console.error('Error:', err);
          historyContent.innerHTML = '<p style="text-align: center; color: red;">Gagal memuat riwayat.</p>';
        });
    }

    function loadTeknijiList() {
      fetch('/api/teknisi')
        .then(response => response.json())
        .then(data => {
          const teknijiList = document.getElementById('teknijiList');
          if (data.length === 0) {
            teknijiList.innerHTML = '<p>Tidak ada teknisi yang tersedia</p>';
            return;
          }
          
          let html = '<div class="tekniji-items">';
          data.forEach(item => {
            html += `<div class="tekniji-item" style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
              <input type="checkbox" name="teknisi" value="${item.id}" id="tech-${item.id}" style="width: 20px; height: 20px;">
              <label for="tech-${item.id}" class="tekniji-name">${item.user}</label>
            </div>`;
          });
          html += '</div>';
          teknijiList.innerHTML = html;
        })
        .catch(error => {
          console.error('Error:', error);
          document.getElementById('teknijiList').innerHTML = '<p>Error loading data</p>';
        });
    }

    function submitMultipleAssignments() {
      const selectedTechs = Array.from(document.querySelectorAll('input[name="teknisi"]:checked'))
        .map(cb => parseInt(cb.value));
      
      if (selectedTechs.length === 0) {
        alert('Pilih minimal satu teknisi');
        return;
      }

      if (!selectedFCU) {
        alert('Pilih FCU terlebih dahulu');
        return;
      }

      const payload = {
        fcu_id: parseInt(selectedFCU.id),
        teknisi_ids: selectedTechs
      };

      console.log('Sending payload:', payload);

      fetch('/api/assign-task', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify(payload)
      })
      .then(async response => {
        const text = await response.text();
        try {
          return JSON.parse(text);
        } catch (e) {
          throw new Error('Server returned invalid JSON: ' + text);
        }
      })
      .then(data => {
        if (data.success) {
          alert(`Task berhasil dikirim ke ${selectedTechs.length} teknisi`);
          closeModal('tekniji');
          selectedFCU = null;
          loadFCUList();
        } else {
          alert('Gagal: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(error => {
        console.error('Fetch error detail:', error);
        alert('Terjadi kesalahan saat mengirim data.');
      });
    }

    window.onclick = function(event) {
      ['fcuModal', 'fcuDetailModal', 'teknijiModal', 'pumpModal', 'gensetModal', 'electricModal', 'mcfaModal'].forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (event.target === modal) {
          modal.style.display = 'none';
        }
      });
    }
  </script>
</body>
</html>
