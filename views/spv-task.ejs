<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jadwal Hari ini - SPV</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div class="container dashboard">
    <div class="header-section">
      <div>
        <h1 class="brand-title"><i class="fas fa-calendar-alt text-primary"></i> Jadwal Maintenance</h1>
        <p class="welcome-msg">Kelola penugasan unit hari ini</p>
      </div>
      <button class="notification-badge" onclick="location.href='/spv'">
        <i class="fas fa-arrow-left"></i>
      </button>
    </div>
    
    <div class="menu-grid">
      <div class="menu-card modern" onclick="showModal('fcu')">
        <div class="menu-icon-wrapper blue">
          <i class="fas fa-snowflake"></i>
        </div>
        <div class="menu-info">
          <div class="menu-title">FCU</div>
          <div class="menu-desc">Fan Coil Unit</div>
        </div>
      </div>
      <div class="menu-card modern" onclick="showModal('pump')">
        <div class="menu-icon-wrapper blue">
          <i class="fas fa-tint"></i>
        </div>
        <div class="menu-info">
          <div class="menu-title">PUMP</div>
          <div class="menu-desc">Water Pump System</div>
        </div>
      </div>
      <div class="menu-card modern" onclick="showModal('genset')">
        <div class="menu-icon-wrapper orange">
          <i class="fas fa-bolt"></i>
        </div>
        <div class="menu-info">
          <div class="menu-title">GENSET</div>
          <div class="menu-desc">Generator Set</div>
        </div>
      </div>
      <div class="menu-card modern" onclick="showModal('electric')">
        <div class="menu-icon-wrapper purple">
          <i class="fas fa-plug"></i>
        </div>
        <div class="menu-info">
          <div class="menu-title">ELECTRIC</div>
          <div class="menu-desc">Electrical Panel</div>
        </div>
      </div>
      <div class="menu-card modern" onclick="showModal('mcfa')">
        <div class="menu-icon-wrapper red">
          <i class="fas fa-cog"></i>
        </div>
        <div class="menu-info">
          <div class="menu-title">MCFA</div>
          <div class="menu-desc">Fire Alarm System</div>
        </div>
      </div>
    </div>
  </div>

  <!-- FCU Modal - List View -->
  <div id="fcuModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i class="fas fa-list"></i> Daftar Unit FCU</h2>
        <span class="close" onclick="closeModal('fcu')">&times;</span>
      </div>
      <div class="modal-body">
        <div id="fcuList" class="fcu-list"></div>
      </div>
    </div>
  </div>

  <!-- FCU Detail Modal -->
  <div id="fcuDetailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i class="fas fa-info-circle"></i> Detail FCU</h2>
        <span class="close" onclick="closeModal('fcuDetail')">&times;</span>
      </div>
      <div class="modal-body">
        <div id="fcuDetailContent" class="glass-card" style="padding: 20px; border-radius: 20px; margin-bottom: 24px;">
          <table class="detail-table" style="width: 100%; border-collapse: separate; border-spacing: 0 10px;">
            <tr>
              <td style="color: var(--text-secondary); font-weight: 600;">ID Unit</td>
              <td id="detail-id" style="text-align: right; font-weight: 700; color: var(--primary);"></td>
            </tr>
            <tr>
              <td style="color: var(--text-secondary); font-weight: 600;">Lantai</td>
              <td id="detail-lantai" style="text-align: right; font-weight: 700;"></td>
            </tr>
            <tr>
              <td style="color: var(--text-secondary); font-weight: 600;">Nama Unit</td>
              <td id="detail-unit" style="text-align: right; font-weight: 700;"></td>
            </tr>
            <tr>
              <td style="color: var(--text-secondary); font-weight: 600;">Alias</td>
              <td id="detail-alias" style="text-align: right; font-weight: 700;"></td>
            </tr>
            <tr>
              <td style="color: var(--text-secondary); font-weight: 600;">Tanggal</td>
              <td id="detail-tanggal" style="text-align: right; font-weight: 700;"></td>
            </tr>
          </table>
        </div>
        <div class="modal-actions" style="display: flex; flex-direction: column; gap: 12px;">
          <button id="assignBtn" onclick="showTeknijiModal()" class="btn btn-primary"><i class="fas fa-user-plus"></i> Pilih Teknisi</button>
          <button id="reassignBtn" onclick="showTeknijiModal(true)" class="btn btn-warning" style="display: none; background: #f59e0b; color: white;"><i class="fas fa-user-gear"></i> Reassign Teknisi</button>
          <button onclick="showHistoryModal()" class="btn btn-secondary"><i class="fas fa-history"></i> Lihat Riwayat</button>
          <button onclick="closeModal('fcuDetail')" class="btn btn-secondary" style="background: var(--bg-main); border: none;">Kembali</button>
        </div>
      </div>
    </div>
  </div>

  <!-- History Modal -->
  <div id="historyModal" class="modal">
    <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
      <div class="modal-header">
        <h2>Riwayat Maintenance</h2>
        <span class="close" onclick="closeModal('history')">&times;</span>
      </div>
      <div class="modal-body">
        <div id="historyContent" class="history-list">
          <!-- History items will be injected here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Teknisi Selection Modal -->
  <div id="teknijiModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Pilih Teknisi</h2>
        <span class="close" onclick="closeModal('tekniji')">&times;</span>
      </div>
      <div class="modal-body">
        <div id="teknijiList" class="tekniji-list"></div>
        <div class="modal-actions" style="margin-top: 20px; text-align: right;">
          <button onclick="submitMultipleAssignments()" class="btn-primary">Kirim Tugas</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Other Equipment Modals -->
  <div id="pumpModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>PUMP - Jadwal Maintenance</h2>
        <span class="close" onclick="closeModal('pump')">&times;</span>
      </div>
      <div class="modal-body">
        <p>Jadwal maintenance untuk PUMP akan segera hadir</p>
      </div>
    </div>
  </div>

  <div id="gensetModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>GENSET - Jadwal Maintenance</h2>
        <span class="close" onclick="closeModal('genset')">&times;</span>
      </div>
      <div class="modal-body">
        <p>Jadwal maintenance untuk GENSET akan segera hadir</p>
      </div>
    </div>
  </div>

  <div id="electricModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ELECTRIC - Jadwal Maintenance</h2>
        <span class="close" onclick="closeModal('electric')">&times;</span>
      </div>
      <div class="modal-body">
        <p>Jadwal maintenance untuk ELECTRIC akan segera hadir</p>
      </div>
    </div>
  </div>

  <div id="mcfaModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>MCFA - Jadwal Maintenance</h2>
        <span class="close" onclick="closeModal('mcfa')">&times;</span>
      </div>
      <div class="modal-body">
        <p>Jadwal maintenance untuk MCFA akan segera hadir</p>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav modern">
    <a href="/spv" class="nav-item" id="home-nav">
      <div class="nav-icon"><i class="fas fa-home"></i></div>
      <div class="nav-label">Home</div>
    </a>
    <a href="/spv/notifikasi" class="nav-item" id="notif-nav">
      <div class="nav-icon"><i class="fas fa-bell"></i></div>
      <div class="nav-label">Notifikasi</div>
    </a>
    <a href="/spv/profile" class="nav-item" id="profile-nav">
      <div class="nav-icon"><i class="fas fa-user-circle"></i></div>
      <div class="nav-label">Profile</div>
    </a>
  </nav>

  <script>
    let selectedFCU = null;
    let isReassignMode = false;

    function showModal(type) {
      const modalId = type + 'Modal';
      document.getElementById(modalId).style.display = 'block';
      
      if (type === 'fcu') {
        loadFCUList();
      }
    }

    function closeModal(type) {
      const modalId = type + 'Modal';
      document.getElementById(modalId).style.display = 'none';
    }

    function loadFCUList() {
      fetch('/api/jadwal')
        .then(response => response.json())
        .then(data => {
          const fcuList = document.getElementById('fcuList');
          if (data.length === 0) {
            fcuList.innerHTML = `
              <div class="empty-state">
                <div class="empty-icon-wrapper">
                  <i class="fas fa-calendar-check"></i>
                </div>
                <p>Tidak ada jadwal FCU untuk hari ini</p>
              </div>
            `;
            return;
          }
          
          let html = '<div class="fcu-items" style="display: flex; flex-direction: column; gap: 12px;">';
          data.forEach((item, index) => {
            const date = new Date(item.tanggal).toLocaleDateString('id-ID', {
              day: 'numeric', month: 'short', year: 'numeric'
            });

            let statusBadge = '';
            let techInfo = '';
            const status = item.assignment_status;
            
            if (!status) {
              statusBadge = `<span style="padding: 4px 8px; border-radius: 8px; font-size: 0.7rem; font-weight: 800; background: rgba(100, 116, 139, 0.1); color: #64748b; text-transform: uppercase;">Not Assign</span>`;
            } else if (status === 'pending') {
              statusBadge = `<span style="padding: 4px 8px; border-radius: 8px; font-size: 0.7rem; font-weight: 800; background: rgba(245, 158, 11, 0.1); color: #d97706; text-transform: uppercase;">Pending</span>`;
              techInfo = `<div style="font-size: 0.75rem; color: #d97706; font-weight: 600; margin-top: 4px;"><i class="fas fa-user-gear"></i> ${item.teknisi_names}</div>`;
            } else if (status === 'assigned' || status === 'in_progress') {
              statusBadge = `<span style="padding: 4px 8px; border-radius: 8px; font-size: 0.7rem; font-weight: 800; background: rgba(var(--primary-rgb), 0.1); color: var(--primary); text-transform: uppercase;">On Progress</span>`;
              techInfo = `<div style="font-size: 0.75rem; color: var(--primary); font-weight: 600; margin-top: 4px;"><i class="fas fa-user-gear"></i> ${item.teknisi_names}</div>`;
            }

            html += `
              <div class="glass-card" style="padding: 16px; display: flex; justify-content: space-between; align-items: center; border-radius: 16px;">
                <div style="display: flex; gap: 12px; align-items: center;">
                  <div style="width: 40px; height: 40px; background: var(--primary-soft); color: var(--primary); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 0.9rem;">
                    ${item.unit}
                  </div>
                  <div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <div style="font-weight: 700; color: var(--text-main); font-size: 0.95rem;">${item.alias}</div>
                      ${statusBadge}
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);"><i class="fas fa-map-marker-alt"></i> ${item.lantai}</div>
                    ${techInfo}
                  </div>
                </div>
                <button onclick="showFCUDetail(${item.id}, '${item.lantai}', '${item.unit}', '${item.alias}', '${date}', '${status}', '${item.assignment_ids || ''}')" class="btn btn-primary" style="width: 44px; height: 44px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 12px; background: rgba(var(--primary-rgb), 0.1); color: var(--primary); border: none; font-size: 1.1rem; transition: all 0.2s;">
                  <i class="fas fa-chevron-right"></i>
                </button>
              </div>
            `;
          });
          html += '</div>';
          fcuList.innerHTML = html;
        })
        .catch(error => {
          console.error('Error:', error);
          document.getElementById('fcuList').innerHTML = '<p>Error loading data</p>';
        });
    }

    function showFCUDetail(id, lantai, unit, alias, tanggal, status, assignmentIds) {
      console.log('Raw showFCUDetail params:', { id, lantai, unit, alias, tanggal, status, assignmentIds });
      id = parseInt(id);
      
      // Bersihkan assignmentIds jika berupa string kosong atau 'null'
      let processedAssignmentIds = [];
      if (assignmentIds && assignmentIds !== 'null' && assignmentIds !== '') {
        processedAssignmentIds = assignmentIds.split(',').filter(id => id.trim() !== '').map(id => parseInt(id));
      }

      selectedFCU = { 
        id, 
        lantai, 
        unit, 
        alias, 
        tanggal, 
        status: (status === 'null' || !status || status === 'undefined') ? null : status, 
        assignmentIds: processedAssignmentIds
      };
      console.log('Processed selectedFCU:', selectedFCU);
      document.getElementById('detail-id').textContent = id;
      document.getElementById('detail-lantai').textContent = lantai;
      document.getElementById('detail-unit').textContent = unit;
      document.getElementById('detail-alias').textContent = alias;
      document.getElementById('detail-tanggal').textContent = tanggal;
      
      // Show/hide buttons based on status
      const assignBtn = document.getElementById('assignBtn');
      const reassignBtn = document.getElementById('reassignBtn');
      
      if (!selectedFCU.status) {
        assignBtn.style.display = 'block';
        reassignBtn.style.display = 'none';
      } else {
        assignBtn.style.display = 'none';
        reassignBtn.style.display = 'block';
      }
      
      closeModal('fcu');
      showModal('fcuDetail');
    }

    function showTeknijiModal(reassign = false) {
      isReassignMode = reassign;
      loadTeknijiList();
      closeModal('fcuDetail');
      showModal('tekniji');
    }

    function showHistoryModal() {
      if (!selectedFCU) return;
      
      const historyContent = document.getElementById('historyContent');
      historyContent.innerHTML = '<p style="text-align: center; padding: 20px;">Memuat riwayat...</p>';
      
      showModal('history');
      
      fetch(`/api/fcu-history/${selectedFCU.id}`)
        .then(res => res.json())
        .then(data => {
          if (data.length === 0) {
            historyContent.innerHTML = `
              <div class="empty-state" style="padding: 20px;">
                <div class="empty-icon-wrapper" style="width: 60px; height: 60px; font-size: 1.5rem;">
                  <i class="fas fa-history"></i>
                </div>
                <p>Belum ada riwayat untuk unit ini.</p>
              </div>
            `;
            return;
          }
          
          let html = '';
          data.forEach(item => {
            const date = new Date(item.created_at).toLocaleDateString('id-ID', {
              day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit'
            });
            html += `
              <div class="glass-card" style="padding: 16px; margin-bottom: 12px; border-radius: 16px; background: var(--bg-main);">
                <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--glass-border);">
                  <strong style="color: var(--primary); font-size: 0.85rem;"><i class="fas fa-calendar-day"></i> ${date}</strong>
                  <span style="font-size: 0.75rem; color: var(--text-secondary);"><i class="fas fa-user-gear"></i> ${item.teknisi_name}</span>
                </div>
                <div style="font-size: 0.85rem; display: flex; flex-direction: column; gap: 8px;">
                  <div>
                    <label style="display: block; font-size: 0.7rem; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 2px;">Temuan</label>
                    <div style="color: var(--text-main);">${item.findings}</div>
                  </div>
                  <div>
                    <label style="display: block; font-size: 0.7rem; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 2px;">Tindakan</label>
                    <div style="color: var(--text-main);">${item.actions_taken}</div>
                  </div>
                  ${item.next_maintenance_date ? `
                    <div style="margin-top: 4px; padding: 8px; background: var(--success-soft); color: var(--success); border-radius: 8px; font-weight: 700; font-size: 0.75rem;">
                      <i class="fas fa-calendar-plus"></i> Jadwal Berikutnya: ${new Date(item.next_maintenance_date).toLocaleDateString('id-ID')}
                    </div>
                  ` : ''}
                </div>
              </div>
            `;
          });
          historyContent.innerHTML = html;
        })
        .catch(err => {
          console.error('Error:', err);
          historyContent.innerHTML = '<p style="text-align: center; color: red;">Gagal memuat riwayat.</p>';
        });
    }

    function loadTeknijiList() {
      fetch('/api/teknisi')
        .then(response => response.json())
        .then(data => {
          const teknijiList = document.getElementById('teknijiList');
          if (data.length === 0) {
            teknijiList.innerHTML = '<p>Tidak ada teknisi yang tersedia</p>';
            return;
          }
          
          let html = '<div class="tekniji-items" style="display: flex; flex-direction: column; gap: 12px;">';
          data.forEach(item => {
            html += `
              <label class="glass-card" style="padding: 16px; display: flex; align-items: center; gap: 12px; border-radius: 16px; cursor: pointer; background: var(--bg-main);">
                <input type="checkbox" name="teknisi" value="${item.id}" style="width: 20px; height: 20px; accent-color: var(--primary);">
                <div style="display: flex; gap: 12px; align-items: center;">
                  <div style="width: 32px; height: 32px; background: var(--primary-soft); color: var(--primary); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-user"></i>
                  </div>
                  <span style="font-weight: 700; color: var(--text-main);">${item.user}</span>
                </div>
              </label>
            `;
          });
          html += '</div>';
          teknijiList.innerHTML = html;
        })
        .catch(error => {
          console.error('Error:', error);
          document.getElementById('teknijiList').innerHTML = '<p>Error loading data</p>';
        });
    }

    function submitMultipleAssignments() {
      const selectedTechs = Array.from(document.querySelectorAll('input[name="teknisi"]:checked'))
        .map(cb => parseInt(cb.value));
      
      if (selectedTechs.length === 0) {
        alert('Pilih minimal satu teknisi');
        return;
      }

      if (!selectedFCU) {
        alert('Pilih FCU terlebih dahulu');
        return;
      }

      if (isReassignMode && (!selectedFCU.assignmentIds || selectedFCU.assignmentIds.length === 0)) {
        alert('Tidak ada penugasan aktif untuk di-reassign pada unit ini');
        return;
      }

      const endpoint = isReassignMode ? '/api/reassign-task' : '/api/assign-task';
      console.log('isReassignMode:', isReassignMode);
      console.log('selectedFCU:', selectedFCU);
      
      const payload = isReassignMode ? {
        fcu_id: parseInt(selectedFCU.id),
        old_assignment_ids: selectedFCU.assignmentIds,
        new_teknisi_ids: selectedTechs
      } : {
        fcu_id: parseInt(selectedFCU.id),
        teknisi_ids: selectedTechs
      };
      
      console.log('Final Payload:', payload);

      fetch(endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify(payload)
      })
      .then(async response => {
        const text = await response.text();
        try {
          return JSON.parse(text);
        } catch (e) {
          throw new Error('Server returned invalid JSON: ' + text);
        }
      })
      .then(data => {
        if (data.success) {
          const actionText = isReassignMode ? 'di-reassign' : 'dikirim';
          alert(`Task berhasil ${actionText} ke ${selectedTechs.length} teknisi`);
          closeModal('tekniji');
          selectedFCU = null;
          loadFCUList();
        } else {
          alert('Gagal: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(error => {
        console.error('Fetch error detail:', error);
        alert('Terjadi kesalahan saat mengirim data.');
      });
    }

    window.onclick = function(event) {
      ['fcuModal', 'fcuDetailModal', 'teknijiModal', 'pumpModal', 'gensetModal', 'electricModal', 'mcfaModal', 'historyModal'].forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (event.target === modal) {
          modal.style.display = 'none';
        }
      });
    }
  </script>
</body>
</html>
